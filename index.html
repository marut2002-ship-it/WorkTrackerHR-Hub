<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Work Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#3B82F6', secondary: '#10B981', accent: '#F3F4F6' } } } }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .modal { display: none; }
        .modal.is-active { display: flex; }

        /* FullCalendar Customizations */
        :root {
          --fc-border-color: #e5e7eb;
          --fc-daygrid-event-dot-width: 8px;
          --fc-list-event-dot-width: 10px;
          --fc-list-event-hover-bg-color: #f3f4f6;
        }
        .fc .fc-toolbar-title { font-size: 1.5em; }
        .fc .fc-button-primary { background-color: #3B82F6; border-color: #3B82F6; }
        .fc .fc-button-primary:hover { background-color: #2563EB; }
        .fc .fc-day-today { background-color: #EFF6FF !important; }
        .fc .fc-event { padding: 4px 6px; font-size: 0.8em; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in">
             <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-primary to-secondary rounded-full mx-auto mb-4 flex items-center justify-center"><svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></div>
                <h1 class="text-2xl font-bold text-gray-800">Work Tracker</h1>
                <p class="text-gray-600 mt-2">เข้าสู่ระบบเพื่อจัดการงานของคุณ</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Username</label><input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required></div>
                <div class="relative"><label class="block text-sm font-medium text-gray-700 mb-2">Password</label><input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required><button type="button" id="togglePassword" class="absolute inset-y-0 right-0 top-7 pr-3 flex items-center text-gray-500"><i class="fas fa-eye"></i></button></div>
                <button type="submit" id="loginBtn" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-xl font-medium flex items-center justify-center"><span id="loginText">เข้าสู่ระบบ</span><div id="loginSpinner" class="loading w-5 h-5 border-2 border-white border-t-transparent rounded-full ml-2 hidden"></div></button>
            </form>
            <div id="loginError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-xl hidden"></div>
        </div>
    </div>

<!-- Main App -->
<div id="mainApp" class="hidden">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <div class="flex items-center"><div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></div><span class="ml-2 text-xl font-bold text-gray-800">Work Tracker</span></div>
                    <div id="main-nav-links" class="hidden md:flex space-x-6">
                        <button onclick="showPage('dashboard', this)" class="nav-btn text-gray-700 px-3 py-2 rounded-lg">ภาพรวม</button>
                        <button onclick="showPage('calendar', this)" class="nav-btn text-gray-700 px-3 py-2 rounded-lg">ปฏิทิน</button>
                        <button onclick="showPage('scheduleForm', this)" class="nav-btn text-gray-700 px-3 py-2 rounded-lg">ลงเวลาปฏิบัติงาน</button>
                        <button id="activity-log-nav" onclick="showPage('activity', this)" class="nav-btn text-gray-700 px-3 py-2 rounded-lg">Activity Log</button>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right"><div class="text-sm font-medium text-gray-800" id="userDisplay"></div><div class="text-xs text-gray-500" id="roleDisplay"></div></div>
                    <button onclick="logout()" class="text-gray-500 hover:text-red-500 p-2 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg></button>
                </div>
            </div>
        </div>
    </nav>
    
    <main>
        <div id="dashboardPage" class="page-content max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"></div>
        <div id="calendarPage" class="page-content max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden"></div>
        <div id="scheduleFormPage" class="page-content max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden"></div>
        <div id="activityPage" class="page-content max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden"></div>
    </main>
    
    <!-- MODAL FOR FULLCALENDAR -->
    <div id="eventModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg fade-in">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800">รายละเอียดงาน</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-black text-2xl">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
        </div>
    </div>
</div>

<script>
// ####################################################################
// ##  สำคัญ! วาง URL ใหม่ล่าสุดที่ได้จากการ DEPLOY ของคุณที่นี่   ##
// ####################################################################
const SCRIPT_URL = 'https://script.google.com/a/macros/srisawadpower.com/s/AKfycbwp3ZNsmnFNpFo33t3QkaeH3FwLXbIpeOPPB1PL-6RNG-FlaHCJwf5FhqhX-bN8HvFb/exec'; 
// ####################################################################

let currentUser = null;
let fullCalendarInstance = null;
const branchInfoMap = new Map();

// --- STARTUP & AUTH ---
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);
    checkSession();
});

function checkSession() {
    const user = sessionStorage.getItem('currentUser');
    if (user) {
        currentUser = JSON.parse(user);
        initializeApp();
    }
}

async function handleLogin(e) {
    e.preventDefault();
    // ... (Login logic is unchanged)
    const loginBtn = document.getElementById('loginBtn');
    const loginText = document.getElementById('loginText');
    const loginSpinner = document.getElementById('loginSpinner');
    const loginError = document.getElementById('loginError');
    loginText.textContent = 'กำลังเข้าสู่ระบบ...';
    loginSpinner.classList.remove('hidden');
    loginBtn.disabled = true;
    loginError.classList.add('hidden');
    try {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const response = await apiGet({ action: 'login', username: username, password: password });
        if (response.status === 'success') {
            currentUser = response.user;
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            initializeApp();
        } else {
            throw new Error(response.message || 'Login failed');
        }
    } catch (error) {
        loginError.textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง หรือเกิดข้อผิดพลาดในการเชื่อมต่อ';
        loginError.classList.remove('hidden');
    } finally {
        loginText.textContent = 'เข้าสู่ระบบ';
        loginSpinner.classList.add('hidden');
        loginBtn.disabled = false;
    }
}

async function initializeApp() {
    document.getElementById('userDisplay').textContent = currentUser.fullName;
    document.getElementById('roleDisplay').textContent = currentUser.role.toLowerCase() === 'employee' ? 'วิทยากรประจำพื้นที่' : currentUser.role;
    if (currentUser.role.toLowerCase() === 'employee') {
        document.getElementById('activity-log-nav').style.display = 'none';
    }
    
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    
    try {
        await fetchBranchData();
        showPage('dashboard', document.querySelector('.nav-btn'));
    } catch (e) {
        alert('เกิดข้อผิดพลาดร้ายแรงในการโหลดข้อมูลพื้นฐาน: ' + e.message);
    }
}

function logout() {
    if (confirm('คุณต้องการออกจากระบบหรือไม่?')) {
        sessionStorage.removeItem('currentUser');
        location.reload();
    }
}

// --- API COMMUNICATION ---
function apiGet(params) {
    // This function for JSONP is still needed for other pages
    return new Promise((resolve, reject) => {
        const url = new URL(SCRIPT_URL);
        if (currentUser) {
            params.username = currentUser.username;
            params.role = currentUser.role;
        }
        const script = document.createElement('script');
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        url.searchParams.append('callback', callbackName);
        Object.keys(params).forEach(key => {
            if (params[key] !== null) url.searchParams.append(key, params[key]);
        });
        window[callbackName] = (data) => {
            delete window[callbackName];
            document.body.removeChild(script);
            resolve(data);
        };
        script.src = url;
        script.onerror = (err) => {
            delete window[callbackName];
            document.body.removeChild(script);
            console.error('JSONP Error:', err);
            reject(new Error('Failed to fetch data via JSONP.'));
        };
        document.body.appendChild(script);
    });
}

// --- PAGE ROUTING & HTML TEMPLATES ---
function showPage(pageId, element) {
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-primary', 'bg-blue-50'));
    if (element) element.classList.add('text-primary', 'bg-blue-50');
    
    document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
    const pageContainer = document.getElementById(pageId + 'Page');
    pageContainer.innerHTML = getPageHTML(pageId);
    pageContainer.classList.remove('hidden');

    switch (pageId) {
        case 'dashboard': initDashboardPage(); break;
        case 'calendar': initCalendarPage(); break;
        // ... (other pages initialize as before)
    }
}

function getPageHTML(pageId) {
    const templates = {
        dashboard: `<div class="fade-in"><h1 class="text-3xl font-bold text-gray-800 mb-6">ภาพรวม</h1><p>Dashboard content goes here.</p></div>`,
        calendar: `<div class="fade-in bg-white p-4 sm:p-6 rounded-2xl shadow-sm border"><div id='calendar'></div></div>`,
        scheduleForm: `<div class="fade-in"><h1 class="text-3xl font-bold text-gray-800 mb-6">ลงเวลา</h1><p>Schedule Form content goes here.</p></div>`,
        activity: `<div class="fade-in"><h1 class="text-3xl font-bold text-gray-800 mb-6">Activity</h1><p>Activity Log content goes here.</p></div>`
    };
    return templates[pageId] || `<h2>Page not found</h2>`;
}

// --- NEW CALENDAR PAGE LOGIC ---
function initCalendarPage() {
    const calendarEl = document.getElementById('calendar');
    const calendarEventsUrl = `${SCRIPT_URL}?action=getCalendarEvents`;

    fullCalendarInstance = new FullCalendar.Calendar(calendarEl, {
        locale: 'th',
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: calendarEventsUrl,
        eventClick: function(info) {
            showCalendarEventModal(info.event);
        },
        loading: function(isLoading) {
            // Optional: add a loading indicator
        }
    });

    fullCalendarInstance.render();
    
    // Modal closing logic
    const modal = document.getElementById('eventModal');
    document.getElementById('closeModalBtn').addEventListener('click', () => modal.classList.remove('is-active'));
    modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('is-active'); });
}

function showCalendarEventModal(event) {
    const modal = document.getElementById('eventModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    
    const props = event.extendedProps;
    
    modalTitle.textContent = event.title;
    
    modalContent.innerHTML = `
        <div class="flex items-start">
            <i class="fa-regular fa-clock text-gray-400 w-5 text-center mt-1"></i>
            <div class="ml-3">
                <p class="text-gray-500 text-sm">เวลา</p>
                <p class="font-semibold text-gray-800">${props.startTime} - ${props.endTime}</p>
            </div>
        </div>
        <div class="flex items-start">
            <i class="fa-solid fa-location-dot text-gray-400 w-5 text-center mt-1"></i>
            <div class="ml-3">
                <p class="text-gray-500 text-sm">สาขา / สถานที่</p>
                <p class="font-semibold text-gray-800">${props.branch}</p>
            </div>
        </div>
        <div class="flex items-start">
            <i class="fa-regular fa-file-lines text-gray-400 w-5 text-center mt-1"></i>
            <div class="ml-3">
                <p class="text-gray-500 text-sm">รายละเอียด</p>
                <p class="text-gray-700 whitespace-pre-wrap">${props.details || 'ไม่มีรายละเอียด'}</p>
            </div>
        </div>
    `;

    modal.classList.add('is-active');
}


// --- OTHER PAGE INITIALIZERS & HELPERS (Keep for other pages to work) ---
function initDashboardPage() { /* Placeholder */ }
async function fetchBranchData() {
    try {
        const response = await apiGet({ action: 'getBranchData' });
        if (response.status === 'success') {
            response.data.forEach(([branchName, area, region]) => {
                branchInfoMap.set(branchName, { area, region });
            });
        }
    } catch (error) {
        console.error("Failed to fetch branches:", error);
        throw error;
    }
}
function togglePasswordVisibility(){const passwordInput=document.getElementById('password');const icon=this.querySelector('i');const type=passwordInput.getAttribute('type')==='password'?'text':'password';passwordInput.setAttribute('type',type);icon.classList.toggle('fa-eye');icon.classList.toggle('fa-eye-slash')}
</script>

</body>
</html>
