<script>
    // ============== JAVASCRIPT LOGIC (V.1.2 - Thai DateTime Formatting) ==============
    
    const SCRIPT_URL = 'https://script.google.com/a/macros/srisawadpower.com/s/AKfycbyN2VkFnduRG3INlwtKbrmKuSfmgBfPe8d2VTRi_inkPMdJTtTjtY9mGgZXwFsS0Y9m/exec';
    let currentUser = null;
    const branchInfoMap = new Map();
    let calendarEvents = [];
    let calendarCurrentDate = new Date();
    let dashboardMasterData = [];

    // --- NEW HELPER FUNCTION for Thai Date/Time Formatting ---
    function formatThaiDateTime(dateString, startTime, endTime) {
        const date = new Date(dateString);
        // Format date to DD-MM-YY (Buddhist year)
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = (date.getFullYear() + 543).toString().slice(-2);
        const formattedDate = `${day}-${month}-${year}`;

        // Format time
        const formattedTime = `${startTime} - ${endTime} น.`;
        
        return { date: formattedDate, time: formattedTime };
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);
        checkSession();
    });

    function apiGet(params) {
        return new Promise((resolve, reject) => {
            const url = new URL(SCRIPT_URL);
            if (currentUser) {
                params.username = currentUser.username;
                params.role = currentUser.role;
            }
            const script = document.createElement('script');
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            url.searchParams.append('callback', callbackName);
            Object.keys(params).forEach(key => {
                if(params[key] !== null) url.searchParams.append(key, params[key]);
            });
            window[callbackName] = (data) => {
                delete window[callbackName];
                document.body.removeChild(script);
                resolve(data);
            };
            script.src = url;
            script.onerror = (err) => {
                delete window[callbackName];
                document.body.removeChild(script);
                console.error('JSONP Error:', err);
                reject(new Error('Failed to fetch data. Check network and SCRIPT_URL.'));
            };
            document.body.appendChild(script);
        });
    }

    function checkSession(){const user=sessionStorage.getItem('currentUser');if(user){currentUser=JSON.parse(user);initializeApp()}}
    async function handleLogin(e){e.preventDefault();const loginBtn=document.getElementById('loginBtn');const loginText=document.getElementById('loginText');const loginSpinner=document.getElementById('loginSpinner');const loginError=document.getElementById('loginError');loginText.textContent='กำลังเข้าสู่ระบบ...';loginSpinner.classList.remove('hidden');loginBtn.disabled=true;loginError.classList.add('hidden');try{const username=document.getElementById('username').value;const password=document.getElementById('password').value;const response=await apiGet({action:'login',username:username,password:password});if(response.status==='success'){currentUser=response.user;sessionStorage.setItem('currentUser',JSON.stringify(currentUser));initializeApp()}else{throw new Error(response.message||'Login failed')}}catch(error){loginError.textContent='ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง หรือเกิดข้อผิดพลาดในการเชื่อมต่อ';loginError.classList.remove('hidden')}finally{loginText.textContent='เข้าสู่ระบบ';loginSpinner.classList.add('hidden');loginBtn.disabled=false}}
    function initializeApp(){document.getElementById('userDisplay').textContent=currentUser.fullName;const roleDisplay=document.getElementById('roleDisplay');if(currentUser.role.toLowerCase()==='employee'){roleDisplay.textContent='วิทยากรประจำพื้นที่';if(document.getElementById('activity-log-nav')){document.getElementById('activity-log-nav').style.display='none'}}else{roleDisplay.textContent=currentUser.role}
    document.getElementById('loginPage').classList.add('hidden');document.getElementById('mainApp').classList.remove('hidden');fetchBranchData().then(()=>{showPage('dashboard',document.querySelector('.nav-btn'))})}
    function logout(){if(confirm('คุณต้องการออกจากระบบหรือไม่?')){sessionStorage.removeItem('currentUser');location.reload()}}
    function togglePasswordVisibility(){const passwordInput=document.getElementById('password');const icon=this.querySelector('i');const type=passwordInput.getAttribute('type')==='password'?'text':'password';passwordInput.setAttribute('type',type);icon.classList.toggle('fa-eye');icon.classList.toggle('fa-eye-slash')}
    function getPageHTML(pageId){const templates={dashboard:`<div class="fade-in"><h1 class="text-3xl font-bold text-gray-800 mb-6">ภาพรวมการลงเวลา</h1><div class="bg-white p-4 rounded-lg shadow-sm border mb-6 grid grid-cols-1 md:grid-cols-6 gap-4 items-end"><div><label class="text-sm font-medium">เดือน</label><input type="month" id="filter-month" class="w-full mt-1 p-2 border rounded-md"></div><div id="user-filter-container" class="hidden"><label class="text-sm font-medium">รายชื่อ HUB</label><select id="filter-hub" class="w-full mt-1 p-2 border rounded-md filter-dropdown"><option value="">ทั้งหมด</option></select></div><div><label class="text-sm font-medium">เขต</label><select id="filter-area" class="w-full mt-1 p-2 border rounded-md filter-dropdown"><option value="">ทั้งหมด</option></select></div><div><label class="text-sm font-medium">ภาค</label><select id="filter-region" class="w-full mt-1 p-2 border rounded-md filter-dropdown"><option value="">ทั้งหมด</option></select></div><button id="apply-filters" class="w-full bg-primary text-white p-2 rounded-md hover:bg-blue-600">กรองข้อมูล</button><button id="clear-filters" class="w-full bg-gray-200 text-gray-700 p-2 rounded-md hover:bg-gray-300">ล้าง</button></div><div id="stats-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div><div class="bg-white rounded-lg shadow-sm border overflow-hidden"><div class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold">ตารางงาน</h2><button id="refresh-table" class="text-primary hover:text-blue-600"><i class="fas fa-sync-alt mr-2"></i>รีเฟรช</button></div><div class="overflow-x-auto"><table class="w-full dense-table"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-medium uppercase">เวลา</th><th class="p-3 text-left text-xs font-medium uppercase">พนักงาน</th><th class="p-3 text-left text-xs font-medium uppercase">สาขา</th><th class="p-3 text-left text-xs font-medium uppercase">เขต</th><th class="p-3 text-left text-xs font-medium uppercase">ภาค</th><th class="p-3 text-left text-xs font-medium uppercase">จัดการ</th></tr></thead><tbody id="dashboard-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></div>`,calendar:`<div class="fade-in"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8"><h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">ปฏิทินงาน</h1><div class="flex items-center space-x-4"><div id="calendar-user-filter-container" class="hidden"><select id="calendar-filter-hub" class="w-full p-2 border rounded-md"><option value="">พนักงานทั้งหมด</option></select></div><div class="flex items-center space-x-2"><button id="cal-prev" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-chevron-left"></i></button><span id="cal-current" class="text-lg font-medium text-gray-800 w-48 text-center"></span><button id="cal-next" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-chevron-right"></i></button></div></div></div><div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div id="calendarGrid" class="p-4"></div></div></div>`,scheduleForm:`<div class="fade-in"><h1 class="text-3xl font-bold text-gray-800 mb-8">ลงเวลาปฏิบัติงาน</h1><div class="bg-white rounded-2xl shadow-sm border p-6 mb-8"><h2 class="text-xl font-bold text-gray-800 mb-6">สร้างตารางงานใหม่</h2><form id="scheduleForm" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="scheduleDate" class="block text-sm font-medium">วันที่ปฏิบัติงาน</label><input type="date" id="scheduleDate" class="w-full mt-1 p-2 border rounded-md" required></div><div><label for="scheduleUsername" class="block text-sm font-medium">Username</label><input type="text" id="scheduleUsername" class="w-full mt-1 p-2 border bg-gray-100 rounded-md" readonly></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="scheduleStartTime" class="block text-sm font-medium">เวลาเริ่มงาน</label><input type="time" id="scheduleStartTime" class="w-full mt-1 p-2 border rounded-md" required></div><div><label for="scheduleEndTime" class="block text-sm font-medium">เวลาเลิกงาน</label><input type="time" id="scheduleEndTime" class="w-full mt-1 p-2 border rounded-md" required></div></div><div><label for="scheduleBranch" class="block text-sm font-medium">สาขาที่เข้าปฏิบัติงาน</label><input list="branch-list" id="scheduleBranch" class="w-full mt-1 p-2 border rounded-md" placeholder="พิมพ์เพื่อค้นหา..." required><datalist id="branch-list"></datalist></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="scheduleArea" class="block text-sm font-medium">เขต</label><input type="text" id="scheduleArea" class="w-full mt-1 p-2 border bg-gray-100 rounded-md" readonly></div><div><label for="scheduleRegion" class="block text-sm font-medium">ภาค</label><input type="text" id="scheduleRegion" class="w-full mt-1 p-2 border bg-gray-100 rounded-md" readonly></div></div><div><label for="scheduleDetails" class="block text-sm font-medium">รายละเอียดงาน</label><textarea id="scheduleDetails" rows="3" class="w-full mt-1 p-2 border rounded-md" placeholder="ระบุรายละเอียดงาน..."></textarea></div><div class="flex justify-end"><button type="submit" id="saveScheduleBtn" class="px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-xl">บันทึกตารางงาน</button></div></form><div id="scheduleSuccess" class="mt-4 p-4 bg-green-100 text-green-700 rounded-xl hidden"></div></div></div>`,activity:`<div class="fade-in"><h1 class="text-3xl font-bold text-gray-800 mb-8">Activity Log</h1><div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-6 border-b"><h2 class="text-xl font-bold text-gray-800">ประวัติการใช้งาน</h2></div><div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-4 text-left text-xs font-medium uppercase">วัน-เวลา</th><th class="px-6 py-4 text-left text-xs font-medium uppercase">Username</th><th class="px-6 py-4 text-left text-xs font-medium uppercase">กิจกรรม</th></tr></thead><tbody id="activityTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div>`};return templates[pageId]||`<h2>Page not found</h2>`}
    function showPage(pageId,element){document.querySelectorAll('.nav-btn').forEach(btn=>btn.classList.remove('text-primary','bg-blue-50'));if(element)element.classList.add('text-primary','bg-blue-50');const pageContainer=document.getElementById(pageId+'Page');if(pageContainer){document.querySelectorAll('.page-content').forEach(p=>p.classList.add('hidden'));pageContainer.classList.remove('hidden');pageContainer.innerHTML=getPageHTML(pageId);switch(pageId){case'dashboard':initDashboardPage();break;case'calendar':initCalendarPage();break;case'scheduleForm':initScheduleFormPage();break;case'activity':loadActivityLogs();break}}}
    async function initDashboardPage(){document.getElementById('filter-month').value=new Date().toISOString().slice(0,7);await loadDashboardData();document.getElementById('apply-filters').addEventListener('click',applyDashboardFilters);document.getElementById('refresh-table').addEventListener('click',initDashboardPage);document.getElementById('dashboard-table-body').addEventListener('click',handleTableActions);document.querySelectorAll('.filter-dropdown').forEach(el=>el.addEventListener('change',updateDependentFilters));document.getElementById('clear-filters').addEventListener('click',clearDashboardFilters)}
    async function loadDashboardData(){const tableBody=document.getElementById('dashboard-table-body');const statsCards=document.getElementById('stats-cards');const loadingHTML=`<tr><td colspan="6" class="p-6 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลดข้อมูล...</td></tr>`;tableBody.innerHTML=loadingHTML;statsCards.innerHTML='';try{const response=await apiGet({action:'getSchedules',filters:JSON.stringify({month:document.getElementById('filter-month').value})});if(response.status==='success'){dashboardMasterData=response.data;populateAllFilters(dashboardMasterData);renderDashboardTable(dashboardMasterData)}else{tableBody.innerHTML=`<tr><td colspan="6" class="p-6 text-center text-gray-500">ไม่พบข้อมูล</td></tr>`;updateStatsCards([])}}catch(error){tableBody.innerHTML=`<tr><td colspan="6" class="p-6 text-center text-red-500">โหลดข้อมูลล้มเหลว</td></tr>`}}
    function populateAllFilters(data,selected={}){const hubSelect=document.getElementById('filter-hub');const regionSelect=document.getElementById('filter-region');const areaSelect=document.getElementById('filter-area');const populate=(select,options,label,currentValue)=>{select.innerHTML=`<option value="">${label}</option>`;[...new Set(options)].sort().forEach(opt=>{if(opt)select.innerHTML+=`<option value="${opt}" ${opt===currentValue?'selected':''}>${opt}</option>`})};populate(regionSelect,data.map(r=>r[10]),'ภาคทั้งหมด',selected.region);populate(areaSelect,data.map(r=>r[9]),'เขตทั้งหมด',selected.area);if(currentUser.role.toLowerCase()!=='employee'){document.getElementById('user-filter-container').classList.remove('hidden');populate(hubSelect,data.map(r=>r[11]),'HUB ทั้งหมด',selected.hub)}}
    function updateDependentFilters(event){const hub=document.getElementById('filter-hub').value;const area=document.getElementById('filter-area').value;const region=document.getElementById('filter-region').value;let filteredData=dashboardMasterData;if(hub)filteredData=filteredData.filter(r=>r[11]===hub);if(area)filteredData=filteredData.filter(r=>r[9]===area);if(region)filteredData=filteredData.filter(r=>r[10]===region);const selectedValues={hub:hub,area:area,region:region};populateAllFilters(filteredData,selectedValues)}
    function applyDashboardFilters(){const regionFilter=document.getElementById('filter-region').value;const areaFilter=document.getElementById('filter-area').value;const hubFilter=document.getElementById('filter-hub')?document.getElementById('filter-hub').value:null;let filteredData=dashboardMasterData;if(regionFilter)filteredData=filteredData.filter(r=>r[10]===regionFilter);if(areaFilter)filteredData=filteredData.filter(r=>r[9]===areaFilter);if(hubFilter)filteredData=filteredData.filter(r=>r[11]===hubFilter);renderDashboardTable(filteredData)}
    function clearDashboardFilters(){document.getElementById('filter-month').value=new Date().toISOString().slice(0,7);loadDashboardData()}
    
    // --- MODIFIED FUNCTION: renderDashboardTable ---
    function renderDashboardTable(data){
        const tableBody=document.getElementById('dashboard-table-body');
        tableBody.innerHTML='';
        updateStatsCards(data);
        if(data.length > 0){
            data.forEach(row => {
                const [id, ts, user, date, startTime, endTime, branch, details, status, area, region, nickname] = row;
                const { date: thaiDate, time: formattedTime } = formatThaiDateTime(date, startTime, endTime);

                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-50 cursor-pointer view-details" data-id="${id}">
                        <td class="p-3 text-sm">
                            <div>${thaiDate}</div>
                            <div class="text-xs text-gray-500">${formattedTime}</div>
                        </td>
                        <td class="p-3 text-sm">${nickname}</td>
                        <td class="p-3 text-sm">${branch}</td>
                        <td class="p-3 text-sm">${area}</td>
                        <td class="p-3 text-sm">${region}</td>
                        <td class="p-3 text-sm text-center">
                            <button class="text-blue-500 hover:text-blue-700 edit-btn" data-id="${id}" title="แก้ไข"><i class="fas fa-edit"></i></button>
                            <button class="text-red-500 hover:text-red-700 delete-btn ml-2" data-id="${id}" title="ลบ"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        } else {
            tableBody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-gray-500">ไม่พบข้อมูลตามเงื่อนไข</td></tr>`;
        }
    }

    function updateStatsCards(data){const cardsContainer=document.getElementById('stats-cards');cardsContainer.innerHTML=`<div class="bg-blue-100 p-4 rounded-lg"><p class="text-sm text-blue-800">แผนงานทั้งหมด</p><p class="text-2xl font-bold text-blue-900">${data.length}</p></div><div class="bg-green-100 p-4 rounded-lg"><p class="text-sm text-green-800">จำนวนสาขา</p><p class="text-2xl font-bold text-green-900">${new Set(data.map(r=>r[6])).size}</p></div><div class="bg-yellow-100 p-4 rounded-lg"><p class="text-sm text-yellow-800">จำนวนพนักงาน</p><p class="text-2xl font-bold text-yellow-900">${new Set(data.map(r=>r[2])).size}</p></div>`}
    function handleTableActions(e){const target=e.target;const row=target.closest('tr');if(!row)return;const id=row.dataset.id||target.closest('button')?.dataset.id;if(!id)return;if(target.closest('.edit-btn')){openEditModal(id)}else if(target.closest('.delete-btn')){handleDelete(id)}else if(row.classList.contains('view-details')){showEventModal(id,null)}}
    async function openEditModal(id){try{const response=await apiGet({action:'getScheduleById',payload:JSON.stringify({id})});if(response.status==='success'){const data=response.data;const workDate=new Date(data[3]);workDate.setHours(0,0,0,0);const today=new Date();today.setHours(0,0,0,0);if(currentUser.role.toLowerCase()==='employee'&&workDate<today){alert("สิทธิ์ของท่านไม่สามารถแก้ไขข้อมูลย้อนหลังได้");return}
    const formContainer=document.getElementById('editScheduleForm');formContainer.innerHTML=`<input type="hidden" id="edit-schedule-id" value="${data[0]}"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium">วันที่ปฏิบัติงาน</label><input type="date" id="edit-scheduleDate" value="${new Date(data[3]).toISOString().slice(0,10)}" class="w-full mt-1 p-2 border rounded-md" required></div><div><label class="block text-sm font-medium">สาขา</label><input list="branch-list" id="edit-scheduleBranch" value="${data[6]}" class="w-full mt-1 p-2 border rounded-md" required></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium">เวลาเริ่มงาน</label><input type="time" id="edit-scheduleStartTime" value="${data[4]}" class="w-full mt-1 p-2 border rounded-md" required></div><div><label class="block text-sm font-medium">เวลาเลิกงาน</label><input type="time" id="edit-scheduleEndTime" value="${data[5]}" class="w-full mt-1 p-2 border rounded-md" required></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium">เขต</label><input type="text" id="edit-scheduleArea" value="${data[9]}" class="w-full mt-1 p-2 border bg-gray-100 rounded-md" readonly></div><div><label class="block text-sm font-medium">ภาค</label><input type="text" id="edit-scheduleRegion" value="${data[10]}" class="w-full mt-1 p-2 border bg-gray-100 rounded-md" readonly></div></div><div><label class="block text-sm font-medium">รายละเอียด</label><textarea id="edit-scheduleDetails" rows="3" class="w-full mt-1 p-2 border rounded-md">${data[7]||""}</textarea></div><div class="flex justify-end"><button type="submit" class="px-6 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">บันทึกการเปลี่ยนแปลง</button></div>`;document.getElementById('editModal').classList.add('is-active');document.getElementById('editScheduleForm').addEventListener('submit',handleUpdateSchedule);document.getElementById('closeEditModalBtn').addEventListener('click',closeEditModal);document.getElementById('editModal').addEventListener('click',e=>{if(e.target.id==='editModal')closeEditModal()});document.getElementById('edit-scheduleBranch').addEventListener('input',e=>{const info=branchInfoMap.get(e.target.value);document.getElementById('edit-scheduleArea').value=info?info.area:'';document.getElementById('edit-scheduleRegion').value=info?info.region:''})}else{alert(response.message)}}catch(error){alert("เกิดข้อผิดพลาดในการดึงข้อมูล: "+error.message)}}
    function closeEditModal(){document.getElementById('editModal').classList.remove('is-active')}
    async function handleUpdateSchedule(e){e.preventDefault();const payload={id:document.getElementById('edit-schedule-id').value,workDate:document.getElementById('edit-scheduleDate').value,startTime:document.getElementById('edit-scheduleStartTime').value,endTime:document.getElementById('edit-scheduleEndTime').value,branch:document.getElementById('edit-scheduleBranch').value,details:document.getElementById('edit-scheduleDetails').value,area:document.getElementById('edit-scheduleArea').value,region:document.getElementById('edit-scheduleRegion').value,};try{const response=await apiGet({action:'editSchedule',payload:JSON.stringify(payload)});if(response.status==='success'){alert('แก้ไขข้อมูลสำเร็จ!');closeEditModal();initDashboardPage()}else{alert('แก้ไขข้อมูลไม่สำเร็จ: '+response.message)}}catch(error){alert('เกิดข้อผิดพลาด: '+error.message)}}
    async function handleDelete(id){if(confirm('คุณแน่ใจหรือไม่ที่จะลบรายการนี้? การกระทำนี้ไม่สามารถย้อนกลับได้')){try{const response=await apiGet({action:'deleteSchedule',payload:JSON.stringify({id})});if(response.status==='success'){alert('ลบข้อมูลสำเร็จ!');initDashboardPage()}else{alert('ลบข้อมูลไม่สำเร็จ: '+response.message)}}catch(error){alert('เกิดข้อผิดพลาด: '+error.message)}}}
    function initCalendarPage(){document.getElementById('cal-prev').addEventListener('click',()=>{calendarCurrentDate.setMonth(calendarCurrentDate.getMonth()-1);renderCalendar()});document.getElementById('cal-next').addEventListener('click',()=>{calendarCurrentDate.setMonth(calendarCurrentDate.getMonth()+1);renderCalendar()});document.getElementById('closeModalBtn').addEventListener('click',closeEventModal);document.getElementById('eventModal').addEventListener('click',e=>{if(e.target.id==='eventModal')closeEventModal()});loadCalendarData()}
    async function loadCalendarData(){document.getElementById('calendarGrid').innerHTML=`<div class="p-6 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลดปฏิทิน...</div>`;const hubSelect=document.getElementById('calendar-filter-hub');if(currentUser.role.toLowerCase()!=='employee'&&hubSelect){document.getElementById('calendar-user-filter-container').classList.remove('hidden');hubSelect.innerHTML='<option value="">พนักงานทั้งหมด</option>';try{const userResponse=await apiGet({action:'getAllUsers'});if(userResponse.status==='success'){userResponse.data.forEach(user=>{hubSelect.innerHTML+=`<option value="${user.username}">${user.nickname}</option>`})}}catch(e){console.error(e)}
    hubSelect.addEventListener('change',renderCalendar)}
    try{const response=await apiGet({action:'getSchedules',filters:null});if(response.status==='success'){calendarEvents=response.data;renderCalendar()}}catch(error){document.getElementById('calendarGrid').innerHTML=`<p class="text-red-500 p-4">Failed to load calendar events.</p>`}}
    function renderCalendar(){const grid=document.getElementById('calendarGrid');if(!grid)return;const hubFilter=document.getElementById('calendar-filter-hub')?.value;let filteredEvents=calendarEvents;if(hubFilter){filteredEvents=calendarEvents.filter(e=>e[2]===hubFilter)}
    const month=calendarCurrentDate.getMonth(),year=calendarCurrentDate.getFullYear();document.getElementById('cal-current').textContent=calendarCurrentDate.toLocaleDateString('th-TH',{month:'long',year:'numeric'});const firstDay=new Date(year,month,1).getDay(),daysInMonth=new Date(year,month+1,0).getDate();let html=`<div class="grid grid-cols-7 gap-1 text-center font-medium text-gray-500 mb-2"><div>อา</div><div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div>ส</div></div><div class="grid grid-cols-7 gap-1">`;for(let i=0;i<firstDay;i++)html+=`<div></div>`;for(let day=1;day<=daysInMonth;day++){const date=new Date(year,month,day);const dayEvents=filteredEvents.filter(e=>new Date(e[3]).toDateString()===date.toDateString());html+=`<div class="border rounded-lg p-2 min-h-[100px] cursor-pointer hover:bg-gray-100 ${new Date().toDateString()===date.toDateString()?'bg-blue-50':''}" onclick="showEventModal(null, '${date.toISOString()}')"><div class="text-sm ${new Date().toDateString()===date.toDateString()?'font-bold text-primary':''}">${day}</div><div class="text-xs mt-1 space-y-1 overflow-hidden">`;dayEvents.slice(0,3).forEach(event=>{html+=`<div class="bg-primary text-white rounded px-1 truncate" title="${event[11]}_${event[6]}">${event[11]}_${event[6]}</div>`});if(dayEvents.length>3)html+=`<div class="text-gray-500 text-center">+${dayEvents.length-3}</div>`;html+=`</div></div>`}html+=`</div>`;grid.innerHTML=html}
    
    // --- MODIFIED FUNCTION: showEventModal ---
    async function showEventModal(id,dateString){
        const modal=document.getElementById('eventModal');
        const modalDate=document.getElementById('modalDate');
        const modalContent=document.getElementById('modalContent');
        modalContent.innerHTML=`<div class="p-4 text-center"><i class="fas fa-spinner fa-spin"></i></div>`;
        modal.classList.add('is-active');
        let dayEvents;

        if(id){
            try{
                const response=await apiGet({action:'getScheduleById',payload:JSON.stringify({id})});
                if(response.status==='success'){
                    dayEvents=[response.data];
                    modalDate.textContent = new Date(response.data[3]).toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
                } else {
                    modalContent.innerHTML=`<p class="text-red-500">ไม่พบข้อมูล</p>`; return;
                }
            } catch(e){
                modalContent.innerHTML=`<p class="text-red-500">เกิดข้อผิดพลาด</p>`; return;
            }
        } else {
            const date=new Date(dateString);
            modalDate.textContent=date.toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
            dayEvents=calendarEvents.filter(e=>new Date(e[3]).toDateString()===date.toDateString());
        }
        
        modalContent.innerHTML='';
        if(dayEvents.length>0){
            dayEvents.forEach(event=>{
                const { time: formattedTime } = formatThaiDateTime(event[3], event[4], event[5]);
                modalContent.innerHTML+=`
                <div class="border p-4 rounded-lg bg-gray-50">
                    <div class="flex items-center mb-2">
                        <span class="font-semibold text-lg text-primary">${event[11]}</span>
                        <span class="mx-2 text-gray-400">|</span>
                        <span class="text-gray-600">${event[6]}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                        <div class="text-gray-500">เวลา:</div><div class="text-gray-800">${formattedTime}</div>
                        <div class="text-gray-500">เขต:</div><div class="text-gray-800">${event[9]}</div>
                        <div class="text-gray-500">ภาค:</div><div class="text-gray-800">${event[10]}</div>
                    </div>
                    <div class="mt-3 pt-3 border-t">
                        <p class="text-sm text-gray-500">รายละเอียด:</p>
                        <p class="text-sm text-gray-800 whitespace-pre-wrap">${event[7]||'-'}</p>
                    </div>
                </div>`;
            });
        } else {
            modalContent.innerHTML=`<p class="text-gray-500">ไม่มีแผนงานสำหรับวันนี้</p>`;
        }
    }

    function closeEventModal(){document.getElementById('eventModal').classList.remove('is-active')}
    function initScheduleFormPage(){document.getElementById('scheduleUsername').value=currentUser.username;document.getElementById('scheduleDate').valueAsDate=new Date();populateBranchDatalist();document.getElementById('scheduleBranch').addEventListener('input',updateBranchInfo);document.getElementById('scheduleForm').addEventListener('submit',handleSaveSchedule)}
    async function fetchBranchData(){try{const response=await apiGet({action:'getBranchData'});if(response.status==='success'){response.data.forEach(([branchName,area,region])=>{branchInfoMap.set(branchName,{area,region})})}}catch(error){console.error("Failed to fetch branches:",error)}}
    function populateBranchDatalist(){const dataList=document.getElementById('branch-list');if(!dataList)return;dataList.innerHTML='';const onlineOption=document.createElement('option');onlineOption.value='ออนไลน์';dataList.appendChild(onlineOption);branchInfoMap.set('ออนไลน์',{area:'N/A',region:'N/A'});branchInfoMap.forEach((value,key)=>{if(key!=='ออนไลน์'){const option=document.createElement('option');option.value=key;dataList.appendChild(option)}})}
    function updateBranchInfo(e){const info=branchInfoMap.get(e.target.value);document.getElementById('scheduleArea').value=info?info.area:'';document.getElementById('scheduleRegion').value=info?info.region:''}
    async function handleSaveSchedule(e){e.preventDefault();const btn=document.getElementById('saveScheduleBtn');const successMsg=document.getElementById('scheduleSuccess');const payload={username:currentUser.username,workDate:document.getElementById('scheduleDate').value,startTime:document.getElementById('scheduleStartTime').value,endTime:document.getElementById('scheduleEndTime').value,branch:document.getElementById('scheduleBranch').value,details:document.getElementById('scheduleDetails').value,area:document.getElementById('scheduleArea').value,region:document.getElementById('scheduleRegion').value,};btn.disabled=true;btn.textContent='กำลังบันทึก...';try{const response=await apiGet({action:'saveSchedule',payload:JSON.stringify(payload)});if(response.status==='success'){successMsg.textContent='บันทึกตารางงานเรียบร้อยแล้ว!';successMsg.classList.remove('hidden');document.getElementById('scheduleForm').reset();initScheduleFormPage();setTimeout(()=>successMsg.classList.add('hidden'),4000)}else{throw new Error(response.message)}}catch(error){alert('เกิดข้อผิดพลาดในการบันทึก: '+error.message)}finally{btn.disabled=false;btn.textContent='บันทึกตารางงาน'}}
    async function loadActivityLogs(){const tableBody=document.getElementById('activityTableBody');tableBody.innerHTML=`<tr><td colspan="3" class="p-6 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลด...</td></tr>`;try{const response=await apiGet({action:'getActivityLogs'});tableBody.innerHTML='';if(response.status==='success'&&response.data.length>0){response.data.forEach(([timestamp,username,action])=>{tableBody.innerHTML+=`<tr class="hover:bg-gray-50"><td class="p-3 text-sm">${new Date(timestamp).toLocaleString('th-TH')}</td><td class="p-3 text-sm">${username}</td><td class="p-3 text-sm">${action}</td></tr>`})}else{tableBody.innerHTML=`<tr><td colspan="3" class="p-6 text-center text-gray-500">ไม่พบข้อมูล</td></tr>`}}catch(error){tableBody.innerHTML=`<tr><td colspan="3" class="p-6 text-center text-red-500">โหลดข้อมูลล้มเหลว</td></tr>`}}
    
    </script>
</body>
</html>
